<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Leaflet/QGIS2Web Styles -->
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/L.Control.Locate.min.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet-search.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    <link rel="stylesheet" href="css/leaflet-measure.css">

    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
    </style>
    <title>Discoabend Shuttlebus</title>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet/QGIS2Web Scripts -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/L.Control.Locate.min.js"></script>
    <script src="js/multi-style-layer.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>
    <script src="js/leaflet-measure.js"></script>
    <script src="js/leaflet-search.js"></script>

    <!-- Deine Daten -->
    <script src="data/BusDBRoute1_linie_1.js"></script>
    <script src="data/Route1_2.js"></script>
    <script src="data/Discoabend_3.js"></script>

    <script>
    // Highlight-Funktion
    var highlightLayer;
    function highlightFeature(e) {
        highlightLayer = e.target;
        if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
            highlightLayer.setStyle({ color: '#ffff00' });
        } else {
            highlightLayer.setStyle({ fillColor: '#ffff00', fillOpacity: 1 });
        }
        highlightLayer.openPopup();
    }

    // === Leaflet-Karte mit Standard-CRS EPSG:3857 ===
    var map = L.map('map', {
        zoomControl:false,
        maxZoom:19,
        minZoom:1
    }).setView([51.3, 9.1], 10); // Mittelpunkt + Startzoom

    var hash = new L.Hash(map);
    map.attributionControl.setPrefix(
        '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
        '<a href="https://leafletjs.com">Leaflet</a> &middot; ' +
        '<a href="https://qgis.org">QGIS</a>'
    );
    var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

    // OSM als Hintergrundkarte
    var layer_OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // Zoom- und Zusatz-Controls
    L.control.zoom({position: 'topleft'}).addTo(map);
    L.control.locate({locateOptions: {maxZoom: 19}}).addTo(map);
    var measureControl = new L.Control.Measure({
        position: 'topleft',
        primaryLengthUnit: 'meters',
        secondaryLengthUnit: 'kilometers',
        primaryAreaUnit: 'sqmeters',
        secondaryAreaUnit: 'hectares'
    });
    measureControl.addTo(map);
    document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
    document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';

    var bounds_group = new L.featureGroup([]);

    // === Deine Layer ===
    function pop_BusDBRoute1_linie_1(feature, layer) {
        layer.on({
            mouseout: function(e) {
                for (var i in e.target._eventParents) {
                    if (typeof e.target._eventParents[i].resetStyle === 'function') {
                        e.target._eventParents[i].resetStyle(e.target);
                    }
                }
                if (typeof layer.closePopup == 'function') {
                    layer.closePopup();
                } else {
                    layer.eachLayer(function(feature){ feature.closePopup() });
                }
            },
            mouseover: highlightFeature,
        });
        var popupContent = '<table><tr><td colspan="2">' +
            (feature.properties['bez'] !== null ? autolinker.link(String(feature.properties['bez'])) : '') +
            '</td></tr></table>';
        layer.bindPopup(popupContent, { maxHeight: 400 });
    }
    function style_BusDBRoute1_linie_1_0() {
        return { color: 'rgba(255,0,0,1.0)', weight: 4, opacity: 1 };
    }
    var layer_BusDBRoute1_linie_1 = new L.geoJson(json_BusDBRoute1_linie_1, {
        attribution: '',
        interactive: true,
        onEachFeature: pop_BusDBRoute1_linie_1,
        style: style_BusDBRoute1_linie_1_0
    }).addTo(map);
    bounds_group.addLayer(layer_BusDBRoute1_linie_1);

    function pop_Route1_2(feature, layer) {
        var popupContent = '<table>' +
            '<tr><th>Abfahrt Hin</th><td>' + (feature.properties['Abfahrt Hin']||'') + '</td></tr>' +
            '<tr><th>Ankunft Hin</th><td>' + (feature.properties['Ankunft Hin']||'') + '</td></tr>' +
            '<tr><th>Abfahrt Rück</th><td>' + (feature.properties['Abfahrt Rück']||'') + '</td></tr>' +
            '<tr><th>Ankunft Rück</th><td>' + (feature.properties['Ankunft Rück']||'') + '</td></tr>' +
            '<tr><td colspan="2"><strong>' + (feature.properties['Name']||'') + '</strong></td></tr>' +
            '</table>';
        layer.bindPopup(popupContent, { maxHeight: 400 });
    }
    var layer_Route1_2 = new L.geoJson(json_Route1_2, {
        attribution: '',
        interactive: true,
        onEachFeature: pop_Route1_2,
        pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {
                icon: L.icon({ iconUrl: 'markers/Route1_2.svg', iconSize: [32, 32] })
            });
        }
    }).addTo(map);
    bounds_group.addLayer(layer_Route1_2);

    function pop_Discoabend_3(feature, layer) {
        var popupContent = '<table>' +
            '<tr><td><strong>' + (feature.properties['Name']||'') + '</strong></td></tr>' +
            '<tr><th>Ankunft Hin</th><td>' + (feature.properties['Ankunft Hin']||'') + '</td></tr>' +
            '<tr><th>Abfahrt Rück</th><td>' + (feature.properties['Abfahrt Rück']||'') + '</td></tr>' +
            '</table>';
        layer.bindPopup(popupContent, { maxHeight: 400 });
    }
    var layer_Discoabend_3 = new L.geoJson(json_Discoabend_3, {
        attribution: '',
        interactive: true,
        onEachFeature: pop_Discoabend_3,
        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, { radius: 6, color: '#ff0055', fillOpacity: 0.9 });
        }
    }).addTo(map);
    bounds_group.addLayer(layer_Discoabend_3);

    // Layer Control
    var overlaysTree = [
        {label: "Discoabend", layer: layer_Discoabend_3},
        {label: "Route 1", layer: layer_Route1_2},
        {label: "Buslinie", layer: layer_BusDBRoute1_linie_1},
        {label: "OpenStreetMap", layer: layer_OSM, radioGroup: 'bm'}
    ];
    L.control.layers.tree(null, overlaysTree,{collapsed:false}).addTo(map);

    // Karte auf Layer-Bounds zoomen
    if (bounds_group.getLayers().length) {
        map.fitBounds(bounds_group.getBounds());
    }
    </script>
</body>
</html>
